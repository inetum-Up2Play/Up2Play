@if (activities.length === 0) {
<app-empty-activities icon="ph-light ph-users-three" title="¿Tienes algo en mente?"
    message="¡Crea tu actividad y reúne a tu equipo!" aria-live="polite" aria-atomic="true">
</app-empty-activities>
} @else {
<div class="xl:p-5 xl:px-9 2xl:px-24">
    <p-dataview class="border-none!" #dv [value]="visibleActivities" [layout]="layout" emptyMessage=" ">

        <ng-template #header>
            <div class="bg-white p-4 rounded-2xl border border-[#f0f4f2] shadow-sm mb-8">
                <!-- PRIMERA FILA: Filtros y selector de vista -->
                <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                    <!-- CONTENEDOR DE FILTROS -->
                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto grow">
                        <!-- Filtro por nombre -->
                        <p-iconfield iconPosition="left" class="w-full md:flex-1">
                            <p-inputicon styleClass="ph ph-magnifying-glass !text-[#3D6C3F]/80"></p-inputicon>
                            <input pInputText type="text" [(ngModel)]="filterNombre" (ngModelChange)="applyFilters()"
                                placeholder="Buscar por nombre de actividad (ej. Padel, Yoga)..."
                                class="w-full text-sm text-[#3D6C3F]/80! placeholder-[#3D6C3F]/80! bg-white focus-within:border-[#B1DF75]/50! hover:border-[#B1DF75]! transition-colors" />
                        </p-iconfield>

                        <!-- Filtro por deporte -->
                        <p-multiSelect class="w-full md:flex-1" [options]="deportesOptions" [(ngModel)]="filterDeporte"
                            (onChange)="applyFilters()" (onClear)="applyFilters()" placeholder="Deportes"
                            optionLabel="label" optionValue="value" selectedItemsLabel="{0} deportes seleccionados"
                            [maxSelectedLabels]="1" [showClear]="true"
                            styleClass="w-full text-base !text-[#3D6C3F]/80 bg-white focus-within:border-[#B1DF75]/50! hover:border-[#B1DF75]! transition-colors [&_.p-placeholder]:!text-[#3D6C3F]/80">
                        </p-multiSelect>
                    </div>

                    <!-- SELECTOR DE VISTA (derecha) -->
                    <div class="flex justify-end w-full md:w-auto">
                        <p-selectbutton [(ngModel)]="layout" [options]="options" [allowEmpty]="false" class="h-full">
                            <ng-template #item let-item>
                                <i class="pi text-[#3D6C3F] p-[20%]"
                                    [ngClass]="{ 'pi-bars': item === 'list', 'pi-th-large': item === 'grid' }"></i>
                            </ng-template>
                        </p-selectbutton>
                    </div>
                </div>

                <!-- SEGUNDA FILA: Filtros activos (solo si hay filtros) -->
                @if (filterDeporte.length > 0 || filterNombre) {
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <div class="flex flex-wrap items-center gap-2">
                        <span class="text-xs text-gray-400 font-medium mr-2">Filtros activos:</span>

                        <!-- Filtro por deporte -->
                        @if (filterDeporte.length > 0) {
                        @for (deporte of filterDeporte; track deporte) {
                        <div
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-[#3D6C3F]/10 text-[#3D6C3F] text-xs font-bold border border-[#3D6C3F]/20 animate-fade-in">
                            <span>{{ deporte }}</span>
                            <button (click)="removeDeporte(deporte)"
                                class="hover:text-[#152614] cursor-pointer flex items-center ml-1">
                                <i class="ph ph-x text-xs"></i>
                            </button>
                        </div>
                        }
                        }

                        <!-- Filtro por nombre -->
                        @if (filterNombre) {
                        <div
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-[#3D6C3F]/10 text-[#3D6C3F] text-xs font-bold border border-[#3D6C3F]/20 animate-fade-in">
                            <i class="ph ph-magnifying-glass text-xs"></i>
                            <span>"{{ filterNombre }}"</span>
                            <button (click)="filterNombre = ''; applyFilters()"
                                class="hover:text-[#152614] cursor-pointer flex items-center ml-1">
                                <i class="ph ph-x text-xs"></i>
                            </button>
                        </div>
                        }

                        <!-- Botón para limpiar todos -->
                        @if (filterDeporte.length > 0 || filterNombre) {
                        <button (click)="clearFilters()"></button>
                        }
                    </div>
                </div>
                }
            </div>
        </ng-template>

        <ng-template #list let-items>
            <div class="flex flex-col">
                <!-- Mensaje si no hay resultados con filtro -->
                @if (items.length === 0 && (filterNombre || filterDeporte.length > 0)) {
                <div class="flex flex-col items-center justify-center">
                    <app-empty-activities class="w-full" icon="ph ph-smiley-sad" title="Tu lista está vacía..."
                        message="¡No se han encontrado actividades con este filtro!" aria-live="polite"
                        aria-atomic="true">
                    </app-empty-activities>
                </div>
                }
                <!-- ACTIVIDADES EN FORMATO LISTA -->
                @for (activity of items; track activity.id; let first = $first) {
                <div class="flex flex-col sm:flex-row sm:items-center py-6 gap-4"
                    [ngClass]="{ 'border-t border-surface-200 dark:border-surface-700': !first }">

                    <div class="md:w-40 relative shrink-0">
                        <img class="block mx-auto rounded w-full object-cover sm:max-w-[250px]" [src]="activity.deporte | deporteImg"
                            [alt]="activity.nombre" style="aspect-ratio: 16/9;"
                            alt=" {{ activity.nombre }}" />
                    </div>

                    <div class="flex flex-col md:flex-row justify-between md:items-center flex-1 gap-6">
                        <div class="flex flex-col justify-start gap-2">
                            <div>
                                <span class="font-medium text-[#152614] text-sm">
                                    {{ extraerFecha(activity.fecha) }} • {{ extraerHora(activity.fecha) }}
                                </span>
                                <div class="text-lg font-medium mt-2 text-[#3D6C3F] cursor-pointer hover:underline"
                                    (click)="redirigirInfoActividad(activity.id)">
                                    {{ activity.nombre }}
                                </div>
                                <div class="flex items-center gap-2 text-sm text-[#152614] mt-1">
                                    <i class="pi pi-map-marker"></i>
                                    <span>{{ activity.ubicacion }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- BOTONES (parte derecha de la lista) -->
                        <div class="flex flex-col md:items-end gap-4">
                            <span class="text-xl font-bold">{{ activity.precio | currency:'EUR' }}</span>
                            <div class="flex flex-row gap-2">
                                @if (esCreador(activity)) {
                                <button pButton icon="pi pi-cog" label="Gestionar"
                                    class="p-button-secondary p-button-outlined p-button-sm"
                                    (click)="redirigirInfoActividad(activity.id)">
                                </button>
                                <button pButton icon="pi pi-trash" [loading]="loading()"
                                    class="p-button-danger p-button-outlined p-button-sm min-w-32"
                                    [label]="activity.precio != '0.00' ? 'Reembolsar' : 'Eliminar'"
                                    (click)="eliminar(activity.id)">
                                </button>
                                } @else {
                                <p-button label="Ver detalles" (onClick)="redirigirInfoActividad(activity.id)"
                                    [styleClass]="'btn-verDetalles'" iconPos="right">
                                </p-button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                }

                <!-- BOTÓN CARGAR MÁS ACTIVIDADES -->
                <div class="flex justify-center mt-6">
                    @if (visibleActivities.length < filteredActivities.length) { <p-button styleClass="boton-ver-mas"
                        label="Mostrar más actividades" variant="outlined" icon="pi pi-refresh" severity="contrast"
                        (onClick)="loadMore()" [attr.aria-label]="'Mostrar más actividades'">
                        </p-button>
                        }
                </div>
            </div>

        <!-- ACTIVIDADES EN FORMATO GRID -->    
        </ng-template> <ng-template #grid let-items>
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4">
                @for (activity of items; track activity.id) {
                <div class="w-full">
                    <app-activity-card class="h-full block" [attr.aria-label]="activity.nombre"
                        [titulo]="activity.nombre" [fecha]="extraerFecha(activity.fecha)"
                        [hora]="extraerHora(activity.fecha)" [ubicacion]="activity.ubicacion"
                        [imagen]="activity.deporte | deporteImg" [precio]="activity.precio" [botonLabel]="'Gestionar'"
                        [botonStyle]="'btn-editar'" [actividadId]="activity.id">
                    </app-activity-card>
                </div>
                }
            </div>

            <!-- Mensaje si no hay resultados con filtro -->
            @if (items.length === 0 && (filterNombre || filterDeporte.length > 0)) {
            <div class="flex flex-col items-center justify-center">
                <app-empty-activities class="w-full" icon="ph ph-smiley-sad" title="Tu lista está vacía..."
                    message="¡No se han encontrado actividades con este filtro!" aria-live="polite" aria-atomic="true">
                </app-empty-activities>
            </div>
            }

            <!-- BOTÓN CARGAR MÁS ACTIVIDADES -->
            <div class="flex justify-center md:justify-end ver-mas-container md:px-0 mt-6">
                @if (visibleActivities.length < filteredActivities.length) { <p-button styleClass="boton-ver-mas"
                    label="Mostrar más actividades" variant="outlined" icon="pi pi-refresh" severity="contrast"
                    (onClick)="loadMore()" [attr.aria-label]="'Mostrar más actividades'">
                    </p-button>
                    }
            </div>
        </ng-template>

    </p-dataview>
</div>
}
<p-confirmDialog></p-confirmDialog>